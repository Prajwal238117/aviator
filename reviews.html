<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Reviews - Nepal Top-Up</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .reviews-hero {
            background: linear-gradient(135deg, var(--primary-color) 0%, #2980b9 100%);
            color: white;
            padding: 60px 0;
            text-align: center;
        }

        .reviews-hero h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .reviews-hero p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .reviews-stats {
            background-color: white;
            padding: 30px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stats-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 40px;
            padding: 0 20px;
        }

        .review-stat {
            text-align: center;
        }

        .review-stat h3 {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .review-stat p {
            color: var(--gray);
        }

        .reviews-grid {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
        }

        .review-card {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .review-card:hover {
            transform: translateY(-5px);
        }

        .review-header {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .reviewer-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .reviewer-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .reviewer-name .first-name {
            margin-right: 5px;
        }

        .reviewer-info .date-time {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .review-rating {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .review-content {
            color: var(--dark-color);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .review-date {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .reviews-filter {
            max-width: 1200px;
            margin: 40px auto 20px;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .filter-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background-color: #f0f0f0;
            color: var(--dark-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .sort-select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background-color: white;
        }

        .no-reviews {
            text-align: center;
            padding: 40px;
            color: var(--gray);
            font-size: 1.2rem;
        }

        @media (max-width: 992px) {
            .reviews-container {
                padding: 0 20px;
            }
            
            .review-card {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .stats-wrapper {
                flex-direction: column;
                gap: 20px;
            }
            
            .reviews-filter {
                flex-direction: column;
                gap: 15px;
            }
            
            .filter-buttons {
                width: 100%;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .filter-btn {
                white-space: nowrap;
            }
            
            .sort-select {
                width: 100%;
            }
            
            .review-header {
                flex-direction: column;
                text-align: center;
            }
            
            .reviewer-avatar {
                margin: 0 0 15px 0;
            }
            
            .reviewer-info {
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .review-card {
                padding: 15px;
            }
            
            .review-rating {
                font-size: 1.2rem;
            }
            
            .review-content {
                font-size: 0.9rem;
            }
            
            .review-date {
                font-size: 0.8rem;
            }
            
            .filter-btn {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-gamepad"></i> Nepal Top-Up
        </div>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="index.html#products">Games</a>
            <a href="index.html#categories-section">Categories</a>
            <a href="cart.html" class="cart-icon"><i class="fas fa-shopping-cart"></i> <span id="cart-count">0</span></a>
            <a href="profile.html" class="account-icon"><i class="fas fa-user"></i></a>
        </div>
    </nav>

    <!-- Bottom Navigation Bar for Mobile -->
    <div class="mobile-bottom-nav">
        <div class="mobile-nav-items">
            <a href="index.html" class="mobile-nav-item">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="index.html#products" class="mobile-nav-item">
                <i class="fas fa-gamepad"></i>
                <span>Games</span>
            </a>
            <a href="index.html#categories-section" class="mobile-nav-item">
                <i class="fas fa-th-large"></i>
                <span>Categories</span>
            </a>
            <a href="cart.html" class="mobile-nav-item">
                <i class="fas fa-shopping-cart"></i>
                <span>Cart</span>
                <span id="mobile-cart-count">0</span>
            </a>
            <a href="profile.html" class="mobile-nav-item">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </a>
        </div>
    </div>

    <!-- Reviews Hero Section -->
    <section class="reviews-hero">
        <div class="container">
            <h1>Customer Reviews</h1>
            <p>See what our customers have to say about their experience with Nepal Top-Up</p>
        </div>
    </section>

    <!-- Reviews Stats -->
    <section class="reviews-stats">
        <div class="stats-wrapper">
            <div class="review-stat">
                <h3 id="average-rating">0.0</h3>
                <p>Average Rating</p>
            </div>
            <div class="review-stat">
                <h3 id="total-reviews">0</h3>
                <p>Total Reviews</p>
            </div>
            <div class="review-stat">
                <h3 id="positive-reviews">0%</h3>
                <p>Positive Reviews</p>
            </div>
        </div>
    </section>

    <!-- Reviews Filter -->
    <div class="reviews-filter">
        <div class="filter-buttons">
            <button class="filter-btn active" data-rating="all">All Reviews</button>
            <button class="filter-btn" data-rating="5">5 Stars</button>
            <button class="filter-btn" data-rating="4">4 Stars</button>
            <button class="filter-btn" data-rating="3">3 Stars</button>
            <button class="filter-btn" data-rating="2">2 Stars</button>
            <button class="filter-btn" data-rating="1">1 Star</button>
        </div>
        <select class="sort-select" id="sort-reviews">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="highest">Highest Rated</option>
            <option value="lowest">Lowest Rated</option>
        </select>
    </div>

    <!-- Reviews Grid -->
    <div class="reviews-grid" id="reviews-container">
        <!-- Reviews will be loaded here -->
    </div>

    <!-- Firebase Modules -->
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { 
            collection, 
            query, 
            orderBy, 
            getDocs,
            where,
            getDoc,
            doc
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // DOM Elements
        const reviewsContainer = document.getElementById('reviews-container');
        const averageRating = document.getElementById('average-rating');
        const totalReviews = document.getElementById('total-reviews');
        const positiveReviews = document.getElementById('positive-reviews');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const sortSelect = document.getElementById('sort-reviews');

        let currentFilter = 'all';
        let currentSort = 'newest';
        let allReviews = [];

        // Load reviews
        async function loadReviews() {
            try {
                const reviewsRef = collection(db, 'reviews');
                let q;

                // Apply filters and sorting
                if (currentFilter === 'all') {
                    q = query(reviewsRef, orderBy('timestamp', 'desc'));
                } else {
                    q = query(
                        reviewsRef,
                        where('rating', '==', parseInt(currentFilter)),
                        orderBy('timestamp', 'desc')
                    );
                }

                const querySnapshot = await getDocs(q);
                allReviews = [];
                let totalRating = 0;
                let positiveCount = 0;

                // Create a map to store user data
                const userDataMap = new Map();

                // First, collect all unique user IDs
                const userIds = new Set();
                querySnapshot.forEach((doc) => {
                    const review = doc.data();
                    if (review.userId) {
                        userIds.add(review.userId);
                    }
                });

                // Fetch all user data in one batch
                const userPromises = Array.from(userIds).map(async (userId) => {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', userId));
                        if (userDoc.exists()) {
                            userDataMap.set(userId, userDoc.data());
                        }
                    } catch (error) {
                        console.error('Error fetching user data:', error);
                    }
                });

                // Wait for all user data to be fetched
                await Promise.all(userPromises);

                querySnapshot.forEach((doc) => {
                    const review = doc.data();
                    review.id = doc.id;
                    
                    // Add user data to the review if available
                    if (review.userId && userDataMap.has(review.userId)) {
                        const userData = userDataMap.get(review.userId);
                        review.firstName = userData.firstName;
                        review.lastName = userData.lastName;
                    }
                    
                    allReviews.push(review);
                    totalRating += review.rating;
                    if (review.rating >= 4) positiveCount++;
                });

                // Apply sorting
                sortReviews();

                // Update stats
                const reviewCount = allReviews.length;
                totalReviews.textContent = reviewCount;
                
                if (reviewCount > 0) {
                    const avgRating = (totalRating / reviewCount).toFixed(1);
                    averageRating.textContent = avgRating;
                    positiveReviews.textContent = `${Math.round((positiveCount / reviewCount) * 100)}%`;
                }

                displayReviews();
            } catch (error) {
                console.error('Error loading reviews:', error);
                showNotification('Error loading reviews', 'error');
            }
        }

        // Sort reviews
        function sortReviews() {
            switch (currentSort) {
                case 'newest':
                    allReviews.sort((a, b) => b.timestamp - a.timestamp);
                    break;
                case 'oldest':
                    allReviews.sort((a, b) => a.timestamp - b.timestamp);
                    break;
                case 'highest':
                    allReviews.sort((a, b) => b.rating - a.rating);
                    break;
                case 'lowest':
                    allReviews.sort((a, b) => a.rating - b.rating);
                    break;
            }
        }

        // Display reviews
        function displayReviews() {
            reviewsContainer.innerHTML = '';

            if (allReviews.length === 0) {
                reviewsContainer.innerHTML = `
                    <div class="no-reviews">
                        <i class="fas fa-comment-slash"></i>
                        <p>No reviews found</p>
                    </div>
                `;
                return;
            }

            allReviews.forEach(review => {
                const reviewCard = document.createElement('div');
                reviewCard.className = 'review-card';
                
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                const date = new Date(review.timestamp).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                reviewCard.innerHTML = `
                    <div class="review-header">
                        <div class="reviewer-info">
                            <div class="reviewer-name">
                                <span class="first-name">${review.firstName || 'Anonymous'}</span>
                                <span class="last-name">${review.lastName || ''}</span>
                            </div>
                            <div class="date-time">${formatDateTime(review.timestamp)}</div>
                        </div>
                    </div>
                    <div class="review-rating">${stars}</div>
                    <div class="review-content">${review.comment}</div>
                `;

                reviewsContainer.appendChild(reviewCard);
            });
        }

        // Event Listeners
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentFilter = button.dataset.rating;
                loadReviews();
            });
        });

        sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            sortReviews();
            displayReviews();
        });

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Format date and time
        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            
            const date = timestamp.toDate();
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Initialize
        loadReviews();
    </script>
</body>
</html> 